<!DOCTYPE html>
<html lang="en">
<head>
    <title>Whoz - simulateur ESN</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="https://dc-js.github.io/dc.js/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://dc-js.github.io/dc.js/css/dc.css"/>
    <style>
	
	.chart-number {
		font-size: 32px;
		font-weight: 600;
		line-height: 27px;
	}
	
	.chart-number-small {
		font-size: 24px;
		font-weight: 600;
		line-height: 18px;
	}
	
	.chart-number-wrapper {
		display: flex;
	}
	
	.input {
		width: 40px;
	}
	
	.billable {
		color: #0038a5;
	}
	
	.interco {
		color: #FFBE3E;
	}
	
	.whoz-price {
		color: #cccccc;
	}
	
	.on-boarding {
		color: #935116;
	}
	
	.shadow-staffing {
		color: #c51b8a
	}
	.lean-start {
		color: #117A65;
	}
	
	.lean-back {
		color: #CB4335;
	}
	
	.kpi {
		margin-right: 30px;
	}
	
	.line1 {
		width: 14%;
		height: 70px;
	}
	
	.line2 {
		width: 16%;
		height: 70px;
	}
	
	.line3 {
		width: 16%;
		height: 70px;
	}
	
	.esn {
		margin-left: 10px;
	}
	
    .heat-box {
        stroke: #ffffff;
        stroke-width: 1px;
    }
	
	.hideCompare {
		display: none;
	}
	
	.showCompare {
		display: flex;
	}
	  
    </style>
</head>
<body>
<div class="esn">

<h2>Whoz - simulateur ESN</h2>
<div style="display: flex;">
<div style="float: left; width: 20%;">
	<label for="name">Période de simulation : <input class="input" type="number" id="nbDays" value=218> jours</label>
	<label for="name">Nombre de consultants staffables : <input class="input" type="number" id="nbConsultant" value=75></label>
	<label for="name">TJM : <input class="input" type="number" id="TJM" value=550>€ et Marge sur coût direct : <input class="input" type="number" id="Margin" value=22>%</label>
</div>
<div style="float: center; width: 20%;">
	<label for="name">Taux d'embauche sur la période : <input class="input" type="number" id="ratioHires" value=15>%</label>
	<label for="name">Taux de départ sur la période : <input class="input" type="number" id="ratioLeavers" value=10>%</label>
	<label for="name">Durée moyenne d'une mission : <input class="input" type="number" id="avgTaskDays" value=140> jours</label>
</div>
<div style="float: right; width: 30%;">
	<label for="name">1er staffing d'un nouvel embauché intervient après : <input class="input" type="number" id="avgDaysFirstStaffing" value=20> jours</label>
	<label for="name">Délai d'interco (entre 2 missions hors reconduction) : <input class="input" type="number" id="taskDelay" value=30> jours</label>
	<label for="name">1 mission sur <input class="input" type="number" id="ratioShadowStaffing" value=30> est sujette au shadow staffing pour <input class="input" type="number" id="shadowStaffingDuration" value=20> jours</label>
</div>
<div style="float: right; width: 30%;">
	<label for="name"><input class="input" type="number" id="ratioTaskRenewNum" value=2> mission(s) sur <input class="input" type="number" id="ratioTaskRenewDenum" value=3> est reconduite pour une durée de <input class="input" type="number" id="ratioTaskRenewDuration" value=50>%</label>
	<label for="name">1 mission sur <input class="input" type="number" id="ratioBeginDelayed" value=9> démarre <input class="input" type="number" id="beginDelayed" value=7> jours de retard par rapport à la planification</label>
	<label for="name">1 mission sur <input class="input" type="number" id="ratioEndBefore" value=19> se termine <input class="input" type="number" id="endBefore" value=10> jours avant la fin planifiée</label>
</div>
</div>
<div style="display: flex; margin-top: 30px;margin-bottom: 30px;">
	<div style="height: 60px; margin-right: 60px;">
		<button onclick="saveSimulation1()">Simulation de référence</button>
		<button onclick="saveSimulation2()">Scenario cible</button>
	</div>
	<div class="resultCompare hideCompare">	
		<div class="kpi">
			<span>CA (Cible-Référence)</span>
			<div class="chart-number-wrapper billable"><div class="chart-number" id="compareCA"></div><div>€</div></div>
		</div>
		<div class="kpi">
			<span>Marge staffable (Cible-Référence)</span>
			<div class="chart-number-wrapper billable"><div class="chart-number" id="compareMargin"></div><div>pts</div></div>
		</div>
		<div class="kpi">
			<span>Interco Coût (Cible-Référence)</span>
			<div class="chart-number-wrapper interco"><div class="chart-number" id="compareIntercoCost"></div><div>€</div></div>
		</div>
		<div class="kpi">
			<span>Whoz Cost</span>
			<div class="chart-number-wrapper whoz-price"><div class="chart-number" id="esnWhozCost"></div><div>€</div></div>
		</div>
	</div>
</div>

<h3>Les KPIs</h3>
<div style="display: flex;margin-left: 40px;">
	<div class="kpi line1">
		<span>TACE</span>
		<div class="chart-number billable" id="esnNumberTACE"></div>
	</div>
	<div class="kpi line1">
		<span>Billable</span>
		<div class="chart-number-wrapper billable"><div class="chart-number" id="esnNumberBillable"></div><div>J</div></div>
	</div>
	<div class="kpi line1">
		<span>CA</span>
		<div class="chart-number-wrapper billable"><div class="chart-number" id="esnCA"></div><div>€</div></div>
	</div>
	<div class="kpi line1">
		<span>Coût global</span>
		<div class="chart-number-wrapper whoz-price"><div class="chart-number" id="esnTotalCost"></div><div>€</div></div>
	</div>
	<div class="kpi line1">
		<span>Marge staffable</span>
		<div class="chart-number-wrapper billable"><div class="chart-number" id="esnGlobalMargin"></div></div>
	</div>
	<div class="kpi line1">
		<span>Interco</span>
		<div class="chart-number-wrapper interco"><div class="chart-number" id="esnInterco"></div><div>J</div></div>
	</div>
	<div class="kpi line1">
		<span>Interco Coût</span>
		<div class="chart-number-wrapper interco"><div class="chart-number" id="esnIntercoCost"></div><div>€</div></div>
	</div>
	<div class="kpi line1">
		<span>Interco CA</span>
		<div class="chart-number-wrapper interco"><div class="chart-number" id="esnIntercoCA"></div><div>€</div></div>
	</div>
</div>
<div style="display: flex;margin-left: 40px;">
	<div class="kpi line2">
		<span>Firt staff</span>
		<div class="chart-number-wrapper on-boarding"><div class="chart-number-small" id="esnOnBoarding"></div><div>J</div></div>
	</div>
	<div class="kpi line2">
		<span>Firt staff Cost</span>
		<div class="chart-number-wrapper on-boarding"><div class="chart-number-small" id="esnOnBoardingCost"></div><div>€</div></div>
	</div>
	<div class="kpi line2">
		<span>Firt staff CA</span>
		<div class="chart-number-wrapper on-boarding"><div class="chart-number-small" id="esnOnBoardingCA"></div><div>€</div></div>
	</div>
	<div class="kpi line2">
		<span>Lean Start</span>
		<div class="chart-number-wrapper lean-start"><div class="chart-number-small" id="esnLeanStart"></div><div>J</div></div>
	</div>
	<div class="kpi line2">
		<span>Lean Start Cost</span>
		<div class="chart-number-wrapper lean-start"><div class="chart-number-small" id="esnLeanStartCost"></div><div>€</div></div>
	</div>
	<div class="kpi line2">
		<span>Lean Start CA</span>
		<div class="chart-number-wrapper lean-start"><div class="chart-number-small" id="esnLeanStartCA"></div><div>€</div></div>
	</div>
</div>
<div style="display: flex;margin-left: 40px;">
	<div class="kpi line3">
		<span>Shadow staffing</span>
		<div class="chart-number-wrapper shadow-staffing"><div class="chart-number-small" id="esnShadowStaffing"></div><div>J</div></div>
	</div>
	<div class="kpi line3">
		<span>Shadow staffing Cost</span>
		<div class="chart-number-wrapper shadow-staffing"><div class="chart-number-small" id="esnShadowStaffingCost"></div><div>€</div></div>
	</div>
	<div class="kpi line3">
		<span>Shadow staffing CA</span>
		<div class="chart-number-wrapper shadow-staffing"><div class="chart-number-small" id="esnShadowStaffingCA"></div><div>€</div></div>
	</div>
	<div class="kpi line3">
		<span>Lean Back</span>
		<div class="chart-number-wrapper lean-back"><div class="chart-number-small" id="esnLeanBack"></div><div>J</div></div>
	</div>
	<div class="kpi line3">
		<span>Lean Back Cost</span>
		<div class="chart-number-wrapper lean-back"><div class="chart-number-small" id="esnLeanBackCost"></div><div>€</div></div>
	</div>
	<div class="kpi line3">
		<span>Lean Back CA</span>
		<div class="chart-number-wrapper lean-back"><div class="chart-number-small" id="esnLeanBackCA"></div><div>€</div></div>
	</div>
</div>

<h3>Matérialisation détaillée des jours considérés</h3>
<div id="esnHeatmap"></div>

<script type="text/javascript" src="https://dc-js.github.io/dc.js/js/d3.js"></script>
<script type="text/javascript" src="https://dc-js.github.io/dc.js/js/crossfilter.js"></script>
<script type="text/javascript" src="https://dc-js.github.io/dc.js/js/dc.js"></script>
<script type="text/javascript">

const firebaseConfig={apiKey:"AIzaSyAdJZlbzyA6ssJu5YyvftEupGIKlAQSPAI",authDomain:"simulator-299fa.firebaseapp.com",databaseURL:"https://simulator-299fa.firebaseio.com",projectId:"simulator-299fa",storageBucket:"simulator-299fa.appspot.com",messagingSenderId:"966834241777",appId:"1:966834241777:web:082d59532e859be085e950",measurementId:"G-NJ3L8JQKES"};firebase.initializeApp(firebaseConfig);var defaultDatabase=firebase.database(),db=firebase.firestore(),nbDays=218,nbConsultant=75,TJM=550,margin=22/100,ratioHires=15/100,ratioLeavers=10/100,avgDaysFirstStaffing=20,avgTaskDays=140,taskDelay=30,ratioTaskRenewNum=2,ratioTaskRenewDenum=3,ratioTaskRenewDuration=50/100,ratioBeginDelayed=9,beginDelayed=7,ratioEndBefore=19,endBefore=10,ratioShadowStaffing=30,shadowStaffingDuration=20,nbUA=nbConsultant/10,UAPrice=1440*(nbDays/218),price=nbUA*UAPrice,loginId=+new Date,loginDate=new Date;saveSimulation1();function getVariables(){return nbConsultant=+document.getElementById("nbConsultant").value,nbDays=+document.getElementById("nbDays").value,TJM=+document.getElementById("TJM").value,ratioHires=+document.getElementById("ratioHires").value/100,ratioLeavers=+document.getElementById("ratioLeavers").value/100,avgTaskDays=+document.getElementById("avgTaskDays").value,avgDaysFirstStaffing=+document.getElementById("avgDaysFirstStaffing").value,taskDelay=+document.getElementById("taskDelay").value,margin=+document.getElementById("Margin").value/100,ratioTaskRenewNum=+document.getElementById("ratioTaskRenewNum").value,ratioTaskRenewDenum=+document.getElementById("ratioTaskRenewDenum").value,ratioTaskRenewDuration=+document.getElementById("ratioTaskRenewDuration").value/100,ratioShadowStaffing=+document.getElementById("ratioShadowStaffing").value,shadowStaffingDuration=+document.getElementById("shadowStaffingDuration").value,beginDelayed=+document.getElementById("beginDelayed").value,ratioBeginDelayed=+document.getElementById("ratioBeginDelayed").value,endBefore=+document.getElementById("endBefore").value,ratioEndBefore=+document.getElementById("ratioEndBefore").value,nbUA=+nbConsultant/10,UAPrice=1440*(nbDays/218),price=nbUA*UAPrice,{nbConsultant,nbDays,TJM,ratioHires,ratioLeavers,avgTaskDays,avgDaysFirstStaffing,taskDelay,margin,ratioTaskRenewNum,ratioTaskRenewDenum,ratioTaskRenewDuration,beginDelayed,ratioBeginDelayed,endBefore,ratioShadowStaffing,shadowStaffingDuration,nbUA,UAPrice,price}}function calculateTaskDays(a){var b;return b=1>=a%10&&4>=a%10?avgTaskDays:5==a%10||7==a%10?Math.floor(.8*avgTaskDays):6==a%10||8==a%10?Math.floor(1.2*avgTaskDays):9==a%10?Math.floor(1.5*avgTaskDays):Math.floor(.5*avgTaskDays),tempCurrentTaskDuration=a%ratioTaskRenewDenum>ratioTaskRenewNum-1?b:Math.floor((1+ratioTaskRenewDuration)*b),tempCurrentTaskDuration}function simulate(){var a=getVariables(),b=[],c=Math.floor(ratioHires*nbConsultant),d=Math.floor(ratioLeavers*nbConsultant),e=Math.floor(nbDays/c),f=Math.floor(nbDays/d),g=+nbConsultant+ +c,h=0,i=1,j=0,k=0,l=1,m=0,n=0;for(let a=0;a<g;a++){var o,p;c--;var q=0<=c?e*c:-1,r=nbDays+1;if(g-a<d){d--;var r=0<d?f*d:nbDays}h!==i&&(p=calculateTaskDays(i),h=i),k=a%p,m=k<=beginDelayed?k:beginDelayed;for(let c=1;c<=nbDays;c++){var s,t,p;h!==i&&(p=calculateTaskDays(i),h=i),c<q||c>r?(s=0,t="NOT WORKING"):0<=q&&c>=q&&c-q<avgDaysFirstStaffing?(s=2,t="ON BOARDING"):1<l&&j<taskDelay&&0==k?(j++,s=2,t="DELAY BETWEEN TASKS"):n<shadowStaffingDuration&&0==i%ratioShadowStaffing?(n++,s=2,t="SHADOW STAFFING"):m<beginDelayed&&0==i%ratioBeginDelayed?(m++,s=2,t="START DELAYED"):0==i%ratioEndBefore&&p-k<=endBefore?(s=2,t="END BEFORE",k++):(s=1,t="BILLABLE",k++),b.push({date:c,start:q,end:r,type:t,consultant:a,occupation:s,text:"Task count: "+i+"\nConsultant task count"+l+"\nTask workload: "+k}),k===p&&(i++,l++,j=0,m=0,n=0,k=0)}i++,j=0,m=0,n=0,k=0,l=1,o=a}var u=crossfilter(b),v=u.dimension(function(a){return[+a.date,a.consultant,a]}),w=v.group().reduceSum(function(a){return+a.occupation}),x=13*nbDays,y=13*g,z=new dc.HeatMap("#esnHeatmap");z.width(x).height(y).transitionDuration(0).dimension(v).group(w).keyAccessor(function(a){return+a.key[0]}).valueAccessor(function(a){return+a.key[1]}).rowsLabel(function(a){return"Consultant "+(g-a)}).colsLabel(function(a){return 1==a||a==nbDays||0==a%10?a:""}).title(function(a){return"Date:   "+a.key[0]+"\nConsultant:  "+a.key[1]+"\nType : "+a.key[2].type+"\noccupation: "+a.value+"\nTask : "+a.key[2].text}).colorAccessor(a=>a.key[2].type).colors(d3.scaleOrdinal().domain(["NOT WORKING","ON BOARDING","DELAY BETWEEN TASKS","SHADOW STAFFING","START DELAYED","END BEFORE","BILLABLE"]).range(["#cfcfcf","#935116","#FFBE3E","#c51b8a","#117A65","#CB4335","#0048B5"])),z.margins({top:20,right:0,bottom:20,left:20}),z.on("renderlet",function(a){var b=a.selectAll("rect"),c=1e4,d=1e4;for(let e of b)e.y.baseVal.value<c&&(c=e.y.baseVal.value),e.x.baseVal.value<d&&(d=e.x.baseVal.value);a.selectAll("g.cols.axis > text").attr("y",c-14),a.select("g.heatmap").attr("transform","translate(70, 15)"),a.select("svg").attr("width",x+100).attr("height",y+100)}),z.render(),kpiDim=u.dimension(function(){return 1});var A=kpiDim.groupAll().reduce((a,b)=>(a.numTACE+=1===b.occupation?1:0,a.denumTACE+=1<=b.occupation?1:0,a.interco+=2===b.occupation?1:0,a.onBoarding+="ON BOARDING"===b.type&&2===b.occupation?1:0,a.shadowStaffing+="SHADOW STAFFING"===b.type&&2===b.occupation?1:0,a.leanStart+="START DELAYED"===b.type&&2===b.occupation?1:0,a.leanBack+="END BEFORE"===b.type&&2===b.occupation?1:0,a.TACE=0<a.denumTACE?a.numTACE/a.denumTACE:0,a.CA=a.numTACE*TJM,a.intercoCA=a.interco*TJM,a.intercoCost=a.interco*TJM*(1-margin),a.onBoardingCA=a.onBoarding*TJM,a.onBoardingCost=a.onBoarding*TJM*(1-margin),a.shadowStaffingCA=a.shadowStaffing*TJM,a.shadowStaffingCost=a.shadowStaffing*TJM*(1-margin),a.leanStartCA=a.leanStart*TJM,a.leanStartCost=a.leanStart*TJM*(1-margin),a.leanBackCA=a.leanBack*TJM,a.leanBackCost=a.leanBack*TJM*(1-margin),a.totalCost=a.denumTACE*TJM*(1-margin),a),(a,b)=>(a.numTACE-=1===b.occupation?1:0,a.denumTACE-=1<=b.occupation?1:0,a.interco-=2===b.occupation?1:0,a.onBoarding-="ON BOARDING"===b.type&&2===b.occupation?1:0,a.shadowStaffing-="SHADOW STAFFING"===b.type&&2===b.occupation?1:0,a.leanStart-="START DELAYED"===b.type&&2===b.occupation?1:0,a.leanBack-="END BEFORE"===b.type&&2===b.occupation?1:0,a.TACE=0<a.denumTACE?a.numTACE/a.denumTACE:0,a.CA=a.numTACE*TJM,a.intercoCA=a.interco*TJM,a.intercoCost=a.interco*TJM*(1-margin),a.onBoardingCA=a.onBoarding*TJM,a.onBoardingCost=a.onBoarding*TJM*(1-margin),a.shadowStaffingCA=a.shadowStaffing*TJM,a.shadowStaffingCost=a.shadowStaffing*TJM*(1-margin),a.leanStartCA=a.leanStart*TJM,a.leanStartCost=a.leanStart*TJM*(1-margin),a.leanBackCA=a.leanBack*TJM,a.leanBackCost=a.leanBack*TJM*(1-margin),a.totalCost=a.denumTACE*TJM*(1-margin),a),()=>({numTACE:0,denumTACE:0,TACE:0,interco:0,onBoarding:0,leanStart:0,leanBack:0,CA:0,intercoCA:0,intercoCost:0,onBoardingCA:0,onBoardingCost:0,leanStartCA:0,leanStartCost:0,leanBackCA:0,leanBackCost:0,shadowStaffing:0,shadowStaffingCA:0,shadowStaffingCost:0,totalCost:0})),B=new dc.NumberDisplay("#esnNumberTACE").formatNumber(d3.format(".2%")).valueAccessor(a=>a.TACE).group(A).render(),C=new dc.NumberDisplay("#esnNumberBillable").formatNumber(d3.format(",.0f")).valueAccessor(a=>a.numTACE).group(A).render(),D=new dc.NumberDisplay("#esnCA").formatNumber(d3.format(".3s")).valueAccessor(a=>a.CA).group(A).render(),E=new dc.NumberDisplay("#esnInterco").formatNumber(d3.format(",.0f")).valueAccessor(a=>a.interco).group(A).render(),F=new dc.NumberDisplay("#esnIntercoCA").formatNumber(d3.format(".3s")).valueAccessor(a=>a.intercoCA).group(A).render(),G=new dc.NumberDisplay("#esnIntercoCost").formatNumber(d3.format(".3s")).valueAccessor(a=>a.intercoCost).group(A).render(),H=new dc.NumberDisplay("#esnOnBoarding").formatNumber(d3.format(",.0f")).valueAccessor(a=>a.onBoarding).group(A).render(),I=new dc.NumberDisplay("#esnOnBoardingCA").formatNumber(d3.format(".3s")).valueAccessor(a=>a.onBoardingCA).group(A).render(),J=new dc.NumberDisplay("#esnOnBoardingCost").formatNumber(d3.format(".3s")).valueAccessor(a=>a.onBoardingCost).group(A).render(),K=new dc.NumberDisplay("#esnShadowStaffing").formatNumber(d3.format(",.0f")).valueAccessor(a=>a.shadowStaffing).group(A).render(),L=new dc.NumberDisplay("#esnShadowStaffingCA").formatNumber(d3.format(".3s")).valueAccessor(a=>a.shadowStaffingCA).group(A).render(),M=new dc.NumberDisplay("#esnShadowStaffingCost").formatNumber(d3.format(".3s")).valueAccessor(a=>a.shadowStaffingCost).group(A).render(),N=new dc.NumberDisplay("#esnLeanStart").formatNumber(d3.format(",.0f")).valueAccessor(a=>a.leanStart).group(A).render(),L=new dc.NumberDisplay("#esnLeanStartCA").formatNumber(d3.format(".3s")).valueAccessor(a=>a.leanStartCA).group(A).render(),M=new dc.NumberDisplay("#esnLeanStartCost").formatNumber(d3.format(".3s")).valueAccessor(a=>a.leanStartCost).group(A).render(),O=new dc.NumberDisplay("#esnLeanBack").formatNumber(d3.format(",.0f")).valueAccessor(a=>a.leanBack).group(A).render(),P=new dc.NumberDisplay("#esnLeanBackCA").formatNumber(d3.format(".3s")).valueAccessor(a=>a.leanBackCA).group(A).render(),Q=new dc.NumberDisplay("#esnLeanBackCost").formatNumber(d3.format(".3s")).valueAccessor(a=>a.leanBackCost).group(A).render(),R=new dc.NumberDisplay("#esnWhozCost").formatNumber(d3.format(".3s")).valueAccessor(()=>price).group(A).render(),Q=new dc.NumberDisplay("#esnTotalCost").formatNumber(d3.format(".3s")).valueAccessor(a=>a.totalCost).group(A).render(),S=new dc.NumberDisplay("#esnGlobalMargin").formatNumber(d3.format(".2%")).valueAccessor(a=>(a.CA-a.totalCost)/a.CA).group(A).render();return{result:A.value(),variables:a}}var simulation1,simulation2;function saveSimulation1(){simulation1=simulate(),simulation1&&simulation2?compare():db.collection("simulation").add({loginId,loginDate,createdAt:firebase.firestore.FieldValue.serverTimestamp(),reference:simulation1})}function saveSimulation2(){simulation2=simulate(),simulation1&&simulation2&&compare()}function compare(){console.log(simulation1,simulation2),db.collection("compare").add({loginId,loginDate,createdAt:firebase.firestore.FieldValue.serverTimestamp(),reference:simulation1,target:simulation2});const a=document.querySelector(".resultCompare");a.classList.replace("hideCompare","showCompare");var b=crossfilter({id:1}),c=b.dimension(function(a){return a.id}),d=c.groupAll().reduceCount(),e=new dc.NumberDisplay("#compareCA").formatNumber(d3.format("+.3s")).valueAccessor(()=>simulation2.result.CA-simulation1.result.CA).group(d).render(),f=new dc.NumberDisplay("#compareMargin").formatNumber(d3.format("+.2f")).valueAccessor(()=>100*((simulation2.result.CA-simulation2.result.totalCost)/simulation2.result.CA-(simulation1.result.CA-simulation1.result.totalCost)/simulation1.result.CA)).group(d).render(),g=new dc.NumberDisplay("#compareIntercoCost").formatNumber(d3.format("+.3s")).valueAccessor(()=>simulation2.result.intercoCost-simulation1.result.intercoCost).group(d).render()}
</script>

</div>
</body>
</html>
